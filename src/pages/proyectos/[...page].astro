---
import type { GetStaticPaths } from "astro";
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/common/PageHeader.astro";
import ProjectCard from "../../components/proyectos/ProjectCard.astro";
import { getCollection } from "astro:content";
import { reader } from "../../utils/keystatic";

// 1. Lógica para rutas estáticas y paginación
export const getStaticPaths = (async ({ paginate }) => {
  // Obtener todos los proyectos
  const proyectosRaw = await getCollection("proyectos");

  // Ordenar por fecha (más reciente primero)
  const proyectosSorted = proyectosRaw.sort(
    (a, b) => b.data.fecha.valueOf() - a.data.fecha.valueOf(),
  );

  // Devolver rutas paginadas (12 elementos por página)
  return paginate(proyectosSorted, { pageSize: 12 });
}) satisfies GetStaticPaths;

// 2. Datos de las propiedades de paginación
const { page } = Astro.props;
const proyectos = page.data;

// 3. Datos de introducción (Singleton)
const introData = await reader.singletons.nuestroTrabajoIntro.read();

const titulo = introData?.titulo || "Nuestros Proyectos";
const descripcion =
  "Explora todas nuestras iniciativas y el impacto que generamos.";

// 4. Calcular años únicos para el filtro
const uniqueYears = [
  ...new Set(proyectos.map((p) => p.data.fecha.getFullYear())),
].sort((a, b) => b - a);
---

<Layout
  title={`Proyectos - Página ${page.currentPage} - Talento para el Desarrollo`}
>
  <main class="bg-zinc-100 min-h-screen flex flex-col relative">
    {/* Superposición de ruido cinematográfico */}
    <div
      class="fixed inset-0 z-50 pointer-events-none opacity-[0.03]"
      style="background-image: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E');"
    >
    </div>

    {/* COMPONENTE DE CABECERA */}
    <PageHeader title={titulo} description={descripcion} />

    {/* CONTENEDOR FLOTANTE SUPERPUESTO */}
    <div class="container mx-auto px-6 lg:px-12 -mt-48 relative z-20 pb-24">
      <div class="relative w-full">
        <div
          class="absolute top-10 -left-10 w-full h-full bg-terracotta-100 z-0"
        >
        </div>
        {/* El "Contenedor que destaca" */}
        <div
          class="bg-white shadow-2xl p-8 md:p-12 border border-zinc-100 relative z-10"
        >
          {/* BARRA DE HERRAMIENTAS DE ORDEN Y FILTRO */}
          <div
            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 pb-6 border-b border-zinc-100"
          >
            <button
              id="sort-toggle"
              class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-zinc-500 hover:text-terracotta-500 transition-colors cursor-pointer bg-transparent border-none p-0"
              data-order="desc"
            >
              <span id="sort-label">Más recientes</span>
              <svg
                id="sort-icon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3"></path>
              </svg>
            </button>

            <div class="flex items-center gap-2">
              <label
                for="year-filter"
                class="text-xs font-bold uppercase tracking-widest text-zinc-400"
              >
                Año
              </label>
              <select
                id="year-filter"
                class="text-sm font-medium text-zinc-700 bg-zinc-50 border border-zinc-200 px-3 py-1.5 focus:outline-none focus:border-terracotta-500 transition-colors cursor-pointer appearance-none pr-8"
                style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 20 20%27%3E%3Cpath stroke=%27%236b7280%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%271.5%27 d=%27M6 8l4 4 4-4%27/%3E%3C/svg%3E'); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em;"
              >
                <option value="all">Todos</option>
                {
                  uniqueYears.map((year) => (
                    <option value={year}>{year}</option>
                  ))
                }
              </select>
            </div>
          </div>

          <div
            id="projects-grid"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12"
          >
            {
              proyectos.map((proyecto, index) => (
                <ProjectCard proyecto={proyecto} index={index} />
              ))
            }
          </div>

          {/* CONTROLES DE PAGINACIÓN */}
          <div
            class="flex justify-between items-center pt-8 border-t border-zinc-100"
          >
            {
              page.url.prev ? (
                <a
                  href={page.url.prev}
                  class="inline-flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-zinc-500 hover:text-terracotta-500 transition-colors group"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4 transition-transform group-hover:-translate-x-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
                    />
                  </svg>
                  Anterior
                </a>
              ) : (
                <span class="w-20" />
              )
            }

            <span
              class="text-xs font-bold uppercase tracking-widest text-zinc-300"
            >
              Página {page.currentPage} de {page.lastPage}
            </span>

            {
              page.url.next ? (
                <a
                  href={page.url.next}
                  class="inline-flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-zinc-500 hover:text-terracotta-500 transition-colors group"
                >
                  Siguiente
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4 transition-transform group-hover:translate-x-1"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"
                    />
                  </svg>
                </a>
              ) : (
                <span class="w-20" />
              )
            }
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sortBtn = document.getElementById("sort-toggle") as HTMLButtonElement;
    const sortLabel = document.getElementById("sort-label")!;
    const sortIcon = document.getElementById("sort-icon")!;
    const yearFilter = document.getElementById(
      "year-filter",
    ) as HTMLSelectElement;
    const grid = document.getElementById("projects-grid")!;

    function getCards(): HTMLElement[] {
      return Array.from(
        grid.querySelectorAll<HTMLElement>(":scope > article[data-date]"),
      );
    }

    function sortCards() {
      const order = sortBtn.dataset.order;
      const cards = getCards();

      cards.sort((a, b) => {
        const dateA = new Date(a.dataset.date!).getTime();
        const dateB = new Date(b.dataset.date!).getTime();
        return order === "desc" ? dateB - dateA : dateA - dateB;
      });

      cards.forEach((card) => grid.appendChild(card));
    }

    function filterCards() {
      const selectedYear = yearFilter.value;
      const cards = getCards();

      cards.forEach((card) => {
        const cardYear = new Date(card.dataset.date!).getFullYear().toString();
        if (selectedYear === "all" || cardYear === selectedYear) {
          card.style.display = "";
        } else {
          card.style.display = "none";
        }
      });
    }

    sortBtn.addEventListener("click", () => {
      const current = sortBtn.dataset.order;
      const newOrder = current === "desc" ? "asc" : "desc";
      sortBtn.dataset.order = newOrder;

      sortLabel.textContent =
        newOrder === "desc" ? "Más recientes" : "Más antiguos";
      sortIcon.style.transform = newOrder === "asc" ? "rotate(180deg)" : "";

      sortCards();
    });

    yearFilter.addEventListener("change", () => {
      filterCards();
    });
  });
</script>

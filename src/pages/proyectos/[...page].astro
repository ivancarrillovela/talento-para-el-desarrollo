---
import type { GetStaticPaths } from "astro";
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/common/PageHeader.astro";
import ProjectCard from "../../components/proyectos/ProjectCard.astro";
import { getCollection } from "astro:content";
import { reader } from "../../utils/keystatic";

// 1. Lógica para rutas estáticas y paginación
export const getStaticPaths = (async ({ paginate }) => {
  // Obtener todos los proyectos
  const proyectosRaw = await getCollection("proyectos");

  // Ordenar por fecha (más reciente primero)
  const proyectosSorted = proyectosRaw.sort(
    (a, b) => b.data.fecha.valueOf() - a.data.fecha.valueOf(),
  );

  // Devolver rutas paginadas (6 elementos por página)
  return paginate(proyectosSorted, { pageSize: 6 });
}) satisfies GetStaticPaths;

// 2. Datos de las propiedades de paginación
const { page } = Astro.props;
const proyectos = page.data;

// 3. Datos de introducción (Singleton)
const introData = await reader.singletons.nuestroTrabajoIntro.read();

const titulo = introData?.titulo || "Nuestros Proyectos";
const descripcion =
  "Explora todas nuestras iniciativas y el impacto que generamos.";

// 4. Calcular años únicos para el filtro
const uniqueYears = [
  ...new Set(proyectos.map((p) => p.data.fecha.getFullYear())),
].sort((a, b) => b - a);
---

<Layout
  title={`Proyectos - Página ${page.currentPage} - Talento para el Desarrollo`}
>
  <main class="bg-zinc-100 min-h-screen flex flex-col relative">
    {/* Superposición de ruido cinematográfico */}
    <div
      class="fixed inset-0 z-50 pointer-events-none opacity-[0.03]"
      style="background-image: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.65\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\'/%3E%3C/svg%3E');"
    >
    </div>

    {/* COMPONENTE DE CABECERA */}
    <PageHeader title={titulo} description={descripcion} />

    {/* CONTENEDOR FLOTANTE SUPERPUESTO */}
    <div class="container mx-auto px-6 lg:px-12 -mt-48 relative z-20 pb-24">
      <div class="relative w-full">
        <div
          class="absolute top-10 -left-10 w-full h-full bg-terracotta-100 z-0"
        >
        </div>
        {/* El "Contenedor que destaca" */}
        <div
          class="bg-white shadow-2xl p-6 md:p-12 border border-zinc-100 relative z-10"
        >
          {/* BARRA DE HERRAMIENTAS DE ORDEN Y FILTRO */}
          <div
            class="flex flex-row justify-between items-center gap-4 mb-8 pb-6 border-b border-zinc-100"
          >
            <button
              id="sort-toggle"
              class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-zinc-500 hover:text-terracotta-500 transition-colors cursor-pointer bg-zinc-50 border border-zinc-200 px-4 py-2 rounded-sm"
              data-order="desc"
            >
              <span id="sort-label">Más recientes</span>
              <svg
                id="sort-icon"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                class="w-4 h-4 transition-transform"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3"></path>
              </svg>
            </button>

            <div class="flex items-center gap-2">
              <label
                for="year-filter"
                class="text-xs font-bold uppercase tracking-widest text-zinc-400"
              >
                Año
              </label>
              <select
                id="year-filter"
                class="text-sm font-medium text-zinc-700 bg-zinc-50 border border-zinc-200 px-3 py-1.5 focus:outline-none focus:border-terracotta-500 transition-colors cursor-pointer appearance-none pr-8"
                style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 20 20%27%3E%3Cpath stroke=%27%236b7280%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27 stroke-width=%271.5%27 d=%27M6 8l4 4 4-4%27/%3E%3C/svg%3E'); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em;"
              >
                <option value="all">Todos</option>
                {
                  uniqueYears.map((year) => (
                    <option value={year}>{year}</option>
                  ))
                }
              </select>
            </div>
          </div>

          <div
            id="projects-grid"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12"
          >
            {
              proyectos.map((proyecto, index) => (
                <ProjectCard proyecto={proyecto} index={index} />
              ))
            }
          </div>

          {/* CONTROLES DE PAGINACIÓN */}
          <div
            id="pagination-controls"
            data-current-page={page.currentPage}
            class="flex flex-wrap justify-between items-center pt-8 border-t border-zinc-100 gap-y-4"
          >
            {
              page.url.prev ? (
                <a
                  href={page.url.prev}
                  class="bg-white border border-zinc-200 text-zinc-600 font-bold uppercase tracking-widest text-xs px-4 py-3 rounded-sm hover:text-terracotta-500 hover:border-terracotta-500 transition-colors shadow-sm inline-flex items-center justify-center gap-2 order-2 w-[45%] sm:w-auto sm:order-1"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
                    />
                  </svg>
                  Anterior
                </a>
              ) : (
                <span class="order-2 w-[45%] sm:w-20 sm:order-1" />
              )
            }

            <span
              class="text-xs font-bold uppercase tracking-widest text-zinc-400 text-center w-full sm:w-auto order-1 sm:order-2 mb-6 sm:mb-0"
            >
              Página {page.currentPage} de {page.lastPage}
            </span>

            {
              page.url.next ? (
                <a
                  href={page.url.next}
                  class="bg-white border border-zinc-200 text-zinc-600 font-bold uppercase tracking-widest text-xs px-4 py-3 rounded-sm hover:text-terracotta-500 hover:border-terracotta-500 transition-colors shadow-sm inline-flex items-center justify-center gap-2 order-3 w-[45%] sm:w-auto sm:order-3"
                >
                  Siguiente
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-4 h-4"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"
                    />
                  </svg>
                </a>
              ) : (
                <span class="order-3 w-[45%] sm:w-20 sm:order-3" />
              )
            }
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
  }
</style>

<script>
  const itemsPerPage = 6;
  let allProjects: any[] = [];
  let filteredProjects: any[] = [];
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", async () => {
    const sortBtn = document.getElementById("sort-toggle") as HTMLButtonElement;
    const sortLabel = document.getElementById("sort-label")!;
    const sortIcon = document.getElementById("sort-icon")!;
    const yearFilter = document.getElementById(
      "year-filter",
    ) as HTMLSelectElement;
    const grid = document.getElementById("projects-grid")!;
    const paginationContainer = document.getElementById("pagination-controls")!;

    // Initialize currentPage from DOM if available
    if (paginationContainer && paginationContainer.dataset.currentPage) {
      currentPage = parseInt(paginationContainer.dataset.currentPage);
    }

    // Initial fetch
    try {
      const response = await fetch("/data/proyectos.json");
      allProjects = await response.json();
      filteredProjects = [...allProjects];

      // Initialize pagination UI for page 1 (if static matches API)
      renderPagination();
    } catch (error) {
      console.error("Error fetching projects:", error);
    }

    function formatDate(dateString: string) {
      const d = new Date(dateString);
      return new Intl.DateTimeFormat("es-ES", {
        day: "numeric",
        month: "long",
        year: "numeric",
      }).format(d);
    }

    function renderProjects() {
      grid.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProjects = filteredProjects.slice(start, end);

      if (pageProjects.length === 0) {
        grid.innerHTML =
          '<p class="col-span-full text-center text-zinc-500 py-12">No se encontraron proyectos con estos criterios.</p>';
        renderPagination();
        return;
      }

      pageProjects.forEach((project, index) => {
        const article = document.createElement("article");
        // Replicating ProjectCard classes
        article.className = `group flex flex-col bg-white rounded-sm shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-500 border border-zinc-100 overflow-hidden animate-fade-in-up h-full relative`;
        article.style.animationDelay = `${index * 100}ms`;
        article.dataset.date = project.fecha;

        const pdfSection = project.pdf
          ? `
          <a
            href="${project.pdf}"
            download
            class="group/pdf relative inline-flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-zinc-900 pb-1 transition-colors overflow-hidden"
          >
            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-zinc-200"></span>
            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-terracotta-500 transform scale-x-0 group-hover/pdf:scale-x-100 transition-transform duration-300 origin-left"></span>
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-4 h-4 relative z-10 group-hover/pdf:text-terracotta-500 transition-colors"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3"
              />
            </svg>
            <span class="relative z-10 group-hover/pdf:text-terracotta-500 transition-colors">
              Descargar PDF
            </span>
          </a>
        `
          : '<span class="block h-5"></span>';

        const imageSrc = project.imagen || "/images/no_image.jpg";

        article.innerHTML = `
          <div class="aspect-[3/2] overflow-hidden bg-zinc-100 relative border-b border-zinc-50 group">
            <div class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur-sm px-3 py-1.5 text-[10px] font-bold uppercase tracking-widest text-zinc-900 shadow-sm border border-white/50 rounded-sm">
              ${formatDate(project.fecha)}
            </div>
            <img
              src="${imageSrc}"
              alt="${project.titulo}"
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 ease-out will-change-transform"
              onerror="this.onerror=null;this.src='/images/no_image.jpg';"
            />
          </div>
          <div class="p-6 md:p-8 flex flex-col flex-grow relative">
            <h2 class="text-xl md:text-2xl font-bold text-zinc-900 mb-3 group-hover:text-terracotta-500 transition-colors leading-tight">
              ${project.titulo}
            </h2>
            <p class="text-zinc-600 leading-relaxed mb-6 text-sm font-light">
              ${project.descripcion}
            </p>
            <div class="mt-auto pt-4 border-t border-zinc-50">
              ${pdfSection}
            </div>
          </div>
        `;
        grid.appendChild(article);
      });

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);

      // Clear existing content
      paginationContainer.innerHTML = "";

      if (totalPages <= 1) return;

      // Prev Button Logic
      const prevBtn = document.createElement("button");
      if (currentPage > 1) {
        prevBtn.className =
          "bg-white border border-zinc-200 text-zinc-600 font-bold uppercase tracking-widest text-xs px-4 py-3 rounded-sm hover:text-terracotta-500 hover:border-terracotta-500 transition-colors shadow-sm inline-flex items-center justify-center gap-2 order-2 w-[45%] sm:w-auto sm:order-1 cursor-pointer";
        prevBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
          </svg>
          Anterior
        `;
        prevBtn.onclick = () => {
          currentPage--;
          renderProjects();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
      } else {
        const placeholder = document.createElement("span");
        placeholder.className = "order-2 w-[45%] sm:w-20 sm:order-1";
        prevBtn.replaceWith(placeholder);
        // We append the placeholder instead if button logic fails, but let's stick to the flow
      }

      // Next Button Logic
      const nextBtn = document.createElement("button");
      if (currentPage < totalPages) {
        nextBtn.className =
          "bg-white border border-zinc-200 text-zinc-600 font-bold uppercase tracking-widest text-xs px-4 py-3 rounded-sm hover:text-terracotta-500 hover:border-terracotta-500 transition-colors shadow-sm inline-flex items-center justify-center gap-2 order-3 w-[45%] sm:w-auto sm:order-3 cursor-pointer";
        nextBtn.innerHTML = `
          Siguiente
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
        `;
        nextBtn.onclick = () => {
          currentPage++;
          renderProjects();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
      } else {
        // placeholder logic
      }

      // Page Info
      const pageInfo = document.createElement("span");
      pageInfo.className =
        "text-xs font-bold uppercase tracking-widest text-zinc-400 text-center w-full sm:w-auto order-1 sm:order-2 mb-6 sm:mb-0";
      pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;

      // Append elements
      if (currentPage > 1) {
        paginationContainer.appendChild(prevBtn);
      } else {
        const p = document.createElement("span");
        p.className = "order-2 w-[45%] sm:w-20 sm:order-1";
        paginationContainer.appendChild(p);
      }

      paginationContainer.appendChild(pageInfo);

      if (currentPage < totalPages) {
        paginationContainer.appendChild(nextBtn);
      } else {
        const p = document.createElement("span");
        p.className = "order-3 w-[45%] sm:w-20 sm:order-3";
        paginationContainer.appendChild(p);
      }
    }

    function applyFilters() {
      const selectedYear = yearFilter.value;
      const order = sortBtn.dataset.order;

      // Filter
      filteredProjects = allProjects.filter((project) => {
        const projectYear = new Date(project.fecha).getFullYear().toString();
        return selectedYear === "all" || projectYear === selectedYear;
      });

      // Sort
      filteredProjects.sort((a, b) => {
        const dateA = new Date(a.fecha).getTime();
        const dateB = new Date(b.fecha).getTime();
        return order === "desc" ? dateB - dateA : dateA - dateB;
      });

      // Reset to page 1
      currentPage = 1;

      // Render
      renderProjects();
    }

    sortBtn.addEventListener("click", () => {
      const current = sortBtn.dataset.order;
      const newOrder = current === "desc" ? "asc" : "desc";
      sortBtn.dataset.order = newOrder;

      sortLabel.textContent =
        newOrder === "desc" ? "Más recientes" : "Más antiguos";
      sortIcon.style.transform = newOrder === "asc" ? "rotate(180deg)" : "";

      applyFilters();
    });

    yearFilter.addEventListener("change", () => {
      applyFilters();
    });
  });
</script>
